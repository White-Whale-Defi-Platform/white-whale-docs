# Bonding Manager

The Bonding Manager is an evolution of the Whale Lair, fee distributor, and fee collector. It allows users to bond WHALE LSDs and earn rewards generated by the system's pools and vaults. The contract collects fees from swaps and flashloans, distributes them as rewards to bonders, and manages the bonding, unbonding, and reward claiming processes.

## Instantiate

Instantiates an instance of the bonding manager contract. The bonding manager should be instantiated after the epoch manager is created and the bonding manager address should be registered on the epoch_manager using `AddHook` to ensure the epoch changed hook is called.

```json
{
  "distribution_denom": "uwhale",
  "unbonding_period": 14,
  "growth_rate": "0.1",
  "bonding_assets": ["uwhale", "ampWHALE", "bWHALE"],
  "grace_period": 21,
  "epoch_manager_addr": "migaloo1..."
}
```

| Key                   | Type         | Description                                                                      |
|-----------------------|--------------|----------------------------------------------------------------------------------|
| `distribution_denom`  | String       | Denom to be swapped to and rewarded                                              |
| `unbonding_period`    | u64          | Unbonding period in epochs                                                       |
| `growth_rate`         | Decimal      | Weight growth rate (between 0 and 1)                                             |
| `bonding_assets`      | Vec<String>  | Denoms of the assets that can be bonded                                          |
| `grace_period`        | u64          | Maximum age of a reward bucket before it's considered expired                    |
| `epoch_manager_addr`  | String       | The address of the epoch manager contract                                        |

## ExecuteMsg

### Bond

Bonds the specified asset.

```json
{
  "bond": {}
}
```

### Unbond

Unbonds the specified asset.

```json
{
  "unbond": {
    "asset": {
      "denom": "uwhale",
      "amount": "1000000"
    }
  }
}
```

| Key     | Type | Description           |
|---------|------|-----------------------|
| `asset` | Coin | The asset to unbond   |

### Withdraw

Sends withdrawable assets of the given denom to the user.

```json
{
  "withdraw": {
    "denom": "uwhale"
  }
}
```

| Key     | Type   | Description              |
|---------|--------|--------------------------|
| `denom` | String | The denom to withdraw    |

### UpdateConfig

Updates the configuration of the contract.

```json
{
  "update_config": {
    "epoch_manager_addr": "migaloo1...",
    "pool_manager_addr": "migaloo1...",
    "unbonding_period": 21,
    "growth_rate": "0.15"
  }
}
```

| Key                   | Type           | Description                           |
|-----------------------|----------------|---------------------------------------|
| `epoch_manager_addr`  | Option<String> | The new epoch manager address         |
| `pool_manager_addr`   | Option<String> | The new pool manager address          |
| `unbonding_period`    | Option<u64>    | The new unbonding period              |
| `growth_rate`         | Option<Decimal> | The new growth rate                   |

### Claim

Claims the available rewards.

```json
{
  "claim": {}
}
```

### ClaimForAddr

Claims the available rewards on behalf of the specified address. Only executable by the contract.

```json
{
  "claim_for_addr": {
    "address": "migaloo1..."
  }
}
```

| Key       | Type   | Description                                |
|-----------|--------|--------------------------------------------|
| `address` | String | The address to claim rewards for           |

### FillRewards

Fills the contract with new rewards.

```json
{
  "fill_rewards": {}
}
```

### EpochChangedHook

Epoch Changed hook implementation. Creates a new reward bucket for the rewards flowing from this time on.
Is triggered, when the epoch manager changes the epoch provided the bonding_manager is registered as a hook.

```json
{
  "epoch_changed_hook": {
    "current_epoch": {
      "id": 1,
      "start_time": "1626307200000000000"
    }
  }
}
```

| Key             | Type  | Description                            |
|-----------------|-------|----------------------------------------|
| `current_epoch` | Epoch | The current epoch, newly created       |

## QueryMsg

### Config

Returns the configuration of the contract.

{% tabs %}
{% tab title="Query" %}
```json
{
  "config": {}
}
```
{% endtab %}

{% tab title="Response (Config)" %}
```json
{
  "pool_manager_addr": "migaloo1...",
  "epoch_manager_addr": "migaloo1...",
  "distribution_denom": "uwhale",
  "unbonding_period": 14,
  "growth_rate": "0.1",
  "bonding_assets": ["uwhale", "ampWHALE", "bWHALE"],
  "grace_period": 21
}
```
{% endtab %}
{% endtabs %}

### Bonded

Returns the amount of assets that have been bonded by the specified address.

{% tabs %}
{% tab title="Query" %}
```json
{
  "bonded": {
    "address": "migaloo1..."
  }
}
```
{% endtab %}

{% tab title="Response (BondedResponse)" %}
```json
{
  "total_bonded": "1000000",
  "bonded_assets": [
    {
      "denom": "uwhale",
      "amount": "1000000"
    }
  ]
}
```
{% endtab %}
{% endtabs %}

### Unbonding

Returns the amount of tokens of the given denom that are being unbonded by the specified address.

{% tabs %}
{% tab title="Query" %}
```json
{
  "unbonding": {
    "address": "migaloo1...",
    "denom": "uwhale",
    "start_after": 0,
    "limit": 10
  }
}
```
{% endtab %}

{% tab title="Response (UnbondingResponse)" %}
```json
{
  "total_amount": "500000",
  "unbonding_requests": [
    {
      "id": 1,
      "created_at_epoch": 10,
      "last_updated": 10,
      "asset": {
        "denom": "uwhale",
        "amount": "500000"
      },
      "weight": "500000",
      "unbonded_at": 24,
      "receiver": "migaloo1..."
    }
  ]
}
```
{% endtab %}
{% endtabs %}

### Withdrawable

Returns the amount of unbonding tokens of the given denom for the specified address that can be withdrawn.

{% tabs %}
{% tab title="Query" %}
```json
{
  "withdrawable": {
    "address": "migaloo1...",
    "denom": "uwhale"
  }
}
```
{% endtab %}

{% tab title="Response (WithdrawableResponse)" %}
```json
{
  "withdrawable_amount": "500000"
}
```
{% endtab %}
{% endtabs %}

### GlobalIndex

Returns the global index of the contract.

{% tabs %}
{% tab title="Query" %}
```json
{
  "global_index": {
    "reward_bucket_id": 1
  }
}
```
{% endtab %}

{% tab title="Response (GlobalIndex)" %}
```json
{
  "epoch_id": 10,
  "bonded_amount": "1000000",
  "bonded_assets": [
    {
      "denom": "uwhale",
      "amount": "1000000"
    }
  ],
  "last_updated": 9,
  "last_weight": "1000000"
}
```
{% endtab %}
{% endtabs %}

### Claimable

Returns the RewardBuckets that can be claimed by an address.

{% tabs %}
{% tab title="Query" %}
```json
{
  "claimable": {
    "address": "migaloo1..."
  }
}
```
{% endtab %}

{% tab title="Response (ClaimableRewardBucketsResponse)" %}
```json
{
  "reward_buckets": [
    {
      "id": 1,
      "epoch_start_time": "1626307200000000000",
      "total": [
        {
          "denom": "uwhale",
          "amount": "1000000"
        }
      ],
      "available": [
        {
          "denom": "uwhale",
          "amount": "500000"
        }
      ],
      "claimed": [
        {
          "denom": "uwhale",
          "amount": "500000"
        }
      ],
      "global_index": {
        "epoch_id": 10,
        "bonded_amount": "1000000",
        "bonded_assets": [
          {
            "denom": "uwhale",
            "amount": "1000000"
          }
        ],
        "last_updated": 9,
        "last_weight": "1000000"
      }
    }
  ]
}
```
{% endtab %}
{% endtabs %}

### Rewards

Returns the rewards for the given address.

{% tabs %}
{% tab title="Query" %}
```json
{
  "rewards": {
    "address": "migaloo1..."
  }
}
```
{% endtab %}

{% tab title="Response (RewardsResponse)" %}
```json
{
  "rewards": [
    {
      "denom": "uwhale",
      "amount": "500000"
    }
  ]
}
```
{% endtab %}
{% endtabs %}