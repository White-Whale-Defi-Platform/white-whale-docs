# Bonding Manager

The Bonding Manager is an evolution of the Whale Lair, fee distributor, and fee collector. It allows users to bond WHALE
LSDs and earn rewards generated by the system's pools and vaults. The contract collects fees from swaps and flashloans,
distributes them as rewards to bonders, and manages the bonding, unbonding, and reward claiming processes.

## Instantiate

Instantiates an instance of the bonding manager contract. The bonding manager should be instantiated after the epoch
manager is created and the bonding manager address should be registered on the epoch_manager using `AddHook` to ensure
the epoch changed hook is called.

```json
{
  "distribution_denom": "uwhale",
  "unbonding_period": 14,
  "growth_rate": "0.1",
  "bonding_assets": [
    "uwhale",
    "ampWHALE",
    "bWHALE"
  ],
  "grace_period": 21,
  "epoch_manager_addr": "migaloo1..."
}
```

| Key                  | Type         | Description                                                   |
|----------------------|--------------|---------------------------------------------------------------|
| `distribution_denom` | String       | Denom to be swapped to and rewarded                           |
| `unbonding_period`   | u64          | Unbonding period in epochs                                    |
| `growth_rate`        | Decimal      | Weight growth rate (between 0 and 1)                          |
| `bonding_assets`     | Vec\<String> | Denoms of the assets that can be bonded                       |
| `grace_period`       | u64          | Maximum age of a reward bucket before it's considered expired |
| `epoch_manager_addr` | String       | The address of the epoch manager contract                     |

## ExecuteMsg

### Bond

Bonds the specified asset. The asset needs to be sent together with the message in the same transaction.

```json
{
  "bond": {}
}
```

### Unbond

Unbonds the specified asset. The asset can be unbonded fully or partially. Unbonded assets don't earn rewards anymore.

```json
{
  "unbond": {
    "asset": {
      "denom": "uwhale",
      "amount": "1000000"
    }
  }
}
```

| Key     | Type | Description         |
|---------|------|---------------------|
| `asset` | Coin | The asset to unbond |

### Withdraw

Once the asset is fully unbonded, this message can be used to send the withdrawable assets of the given denom to the
user.

```json
{
  "withdraw": {
    "denom": "uwhale"
  }
}
```

| Key     | Type   | Description           |
|---------|--------|-----------------------|
| `denom` | String | The denom to withdraw |

### UpdateConfig

Updates the configuration of the contract.

```json
{
  "update_config": {
    "epoch_manager_addr": "migaloo1...",
    "pool_manager_addr": "migaloo1...",
    "unbonding_period": 21,
    "growth_rate": "0.15"
  }
}
```

| Key                  | Type             | Description                   |
|----------------------|------------------|-------------------------------|
| `epoch_manager_addr` | Option\<String>  | The new epoch manager address |
| `pool_manager_addr`  | Option\<String>  | The new pool manager address  |
| `unbonding_period`   | Option\<u64>     | The new unbonding period      |
| `growth_rate`        | Option\<Decimal> | The new growth rate           |

### Claim

Claims the available rewards.

```json
{
  "claim": {}
}
```

### ClaimForAddr

Claims the available rewards on behalf of the specified address. Only executable by the contract.

```json
{
  "claim_for_addr": {
    "address": "migaloo1..."
  }
}
```

| Key       | Type   | Description                      |
|-----------|--------|----------------------------------|
| `address` | String | The address to claim rewards for |

### FillRewards

Fills the contract with new rewards. The contract will handle the tokens sent to it as rewards in different ways, i.e.
if it's a token different from the `distribution_denom`, it will swap it to the `distribution_denom` to be distributed
to
bonders. If the token is an LP token, the contract will withdraw the LP from the respective pool and swap these tokens
to
the `distribution_denom` if needed.

```json
{
  "fill_rewards": {}
}
```

### EpochChangedHook

Epoch Changed hook implementation. Creates a new reward bucket for the rewards flowing from this time on.
Is triggered, when the epoch manager changes the epoch provided the bonding_manager is registered as a hook.

```json
{
  "epoch_changed_hook": {
    "current_epoch": {
      "id": 1,
      "start_time": "1626307200000000000"
    }
  }
}
```

| Key             | Type  | Description                      |
|-----------------|-------|----------------------------------|
| `current_epoch` | Epoch | The current epoch, newly created |

### UpdateOwnership(::cw_ownable::Action)

Implements `cw_ownable`. Updates the contract's ownership. `::cw_ownable::Action` can be `TransferOwnership`,
`AcceptOwnership` and `RenounceOwnership`.

{% tabs %}
{% tab title="TransferOwnership" %}

Propose to transfer the contract's ownership to another account, optionally with an expiry time. Can only be called by
the contract's current owner. Any existing pending ownership transfer is overwritten.

```json
    {
  "update_ownership": {
    "transfer_ownership": {
      "new_owner": "migaloo1...",
      "expiry": {
        "at_height": "424242424242"
      }
    }
  }
}
```

| Key         | Type                | Description                         |
|-------------|---------------------|-------------------------------------|
| `new_owner` | String              | The new owner proposed,             |
| `expiry`    | Option\<Expiration> | Optional expiration time parameter. |

{% endtab %}

{% tab title="AcceptOwnership" %}

Accept the pending ownership transfer. Can only be called by the pending owner.

```json
    {
  "update_ownership": {
    "accept_ownership": {}
  }
}
```

{% endtab %}

{% tab title="RenounceOwnership" %}

Give up the contract's ownership and the possibility of appointing a new owner. Can only be invoked by the contract's
current owner. Any existing pending ownership transfer is canceled.

```json
    {
  "update_ownership": {
    "renounce_ownership": {}
  }
}
```

{% endtab %}
{% endtabs %}

## QueryMsg

### Config

Returns the configuration of the contract.

{% tabs %}
{% tab title="Query" %}

```json
{
  "config": {}
}
```

{% endtab %}

{% tab title="Response (Config)" %}

```json
{
  "pool_manager_addr": "migaloo1...",
  "epoch_manager_addr": "migaloo1...",
  "distribution_denom": "uwhale",
  "unbonding_period": 14,
  "growth_rate": "0.1",
  "bonding_assets": [
    "uwhale",
    "ampWHALE",
    "bWHALE"
  ],
  "grace_period": 21
}
```

| Key                  | Type         | Description                                                                                                                                     |
|----------------------|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| `pool_manager_addr`  | Addr         | Pool Manager contract address for swapping.                                                                                                     |
| `epoch_manager_addr` | Addr         | Epoch Manager contract address.                                                                                                                 |
| `distribution_denom` | String       | Distribution denom for the rewards.                                                                                                             |
| `unbonding_period`   | String       | Unbonding period in epochs. The time (in epochs) that needs to pass before an unbonded position can be withdrawn.                               |
| `growth_rate`        | Decimal      | A fraction that controls the effect of time on the weight of a bond. If the growth rate is set to zero, time will have no impact on the weight. |
| `bonding_assets`     | Vec\<String> | Denom of the asset to be bonded. Can't only be set at instantiation.                                                                            |
| `grace_period`       | u64          | Grace period the maximum age of a reward bucket before it's considered expired and fees are forwarded from it.                                  |

{% endtab %}
{% endtabs %}

### Bonded

Returns the amount of assets that have been bonded by the specified address.

{% tabs %}
{% tab title="Query" %}

```json
{
  "bonded": {
    "address": "migaloo1..."
  }
}
```

{% endtab %}

{% tab title="Response (BondedResponse)" %}

```json
{
  "total_bonded": "1000000",
  "bonded_assets": [
    {
      "denom": "uwhale",
      "amount": "1000000"
    }
  ]
}
```

| Key             | Type       | Description                                                                                                                  |
|-----------------|------------|------------------------------------------------------------------------------------------------------------------------------|
| `total_bonded`  | Uint128    | The total amount of bonded tokens by the address. Bear in mind the bonded assets are considered to be equal for this purpose |
| `bonded_assets` | Vec\<Coin> | The assets that are bonded by the address.                                                                                   |

{% endtab %}
{% endtabs %}

### Unbonding

Returns the amount of tokens of the given denom that are being unbonded by the specified address.

{% tabs %}
{% tab title="Query" %}

```json
{
  "unbonding": {
    "address": "migaloo1...",
    "denom": "uwhale",
    "start_after": 0,
    "limit": 10
  }
}
```

{% endtab %}

{% tab title="Response (UnbondingResponse)" %}

```json
{
  "total_amount": "500000",
  "unbonding_requests": [
    {
      "id": 1,
      "created_at_epoch": 10,
      "last_updated": 10,
      "asset": {
        "denom": "uwhale",
        "amount": "500000"
      },
      "weight": "500000",
      "unbonded_at": 24,
      "receiver": "migaloo1..."
    }
  ]
}
```

| Key                  | Type       | Description                                         |
|----------------------|------------|-----------------------------------------------------|
| `total_amount`       | Uint128    | The total amount of unbonded tokens by the address. |
| `unbonding_requests` | Vec\<Bond> | The total amount of unbonded assets by the address. |

{% endtab %}
{% endtabs %}

### Withdrawable

Returns the amount of unbonding tokens of the given denom for the specified address that can be withdrawn.

{% tabs %}
{% tab title="Query" %}

```json
{
  "withdrawable": {
    "address": "migaloo1...",
    "denom": "uwhale"
  }
}
```

{% endtab %}

{% tab title="Response (WithdrawableResponse)" %}

```json
{
  "withdrawable_amount": "500000"
}
```

| Key                   | Type    | Description                                             |
|-----------------------|---------|---------------------------------------------------------|
| `withdrawable_amount` | Uint128 | The total amount of withdrawable assets by the address. |

{% endtab %}
{% endtabs %}

### GlobalIndex

Returns the global index of the contract.

{% tabs %}
{% tab title="Query" %}

```json
{
  "global_index": {
    "reward_bucket_id": 1
  }
}
```

{% endtab %}

{% tab title="Response (GlobalIndex)" %}

```json
{
  "epoch_id": 10,
  "bonded_amount": "1000000",
  "bonded_assets": [
    {
      "denom": "uwhale",
      "amount": "1000000"
    }
  ],
  "last_updated": 9,
  "last_weight": "1000000"
}
```

| Key             | Type       | Description                                                          |
|-----------------|------------|----------------------------------------------------------------------|
| `epoch_id`      | u64        | The epoch id the global index was taken a snapshot for.              |
| `bonded_amount` | Uint128    | The total amount of tokens bonded in the contract.                   |
| `bonded_assets` | Vec\<Coin> | Assets that are bonded in the contract.                              |
| `last_updated`  | u64        | The epoch id at which the total bond was updated.                    |
| `last_weight`   | Uint128    | The total weight of the contract at the given updated_last epoch id. |

{% endtab %}
{% endtabs %}

### Claimable

Returns the RewardBuckets that can be claimed by an address.

{% tabs %}
{% tab title="Query" %}

```json
{
  "claimable": {
    "address": "migaloo1..."
  }
}
```

{% endtab %}

{% tab title="Response (ClaimableRewardBucketsResponse)" %}

```json
{
  "reward_buckets": [
    {
      "id": 1,
      "epoch_start_time": "1626307200000000000",
      "total": [
        {
          "denom": "uwhale",
          "amount": "1000000"
        }
      ],
      "available": [
        {
          "denom": "uwhale",
          "amount": "500000"
        }
      ],
      "claimed": [
        {
          "denom": "uwhale",
          "amount": "500000"
        }
      ],
      "global_index": {
        "epoch_id": 10,
        "bonded_amount": "1000000",
        "bonded_assets": [
          {
            "denom": "uwhale",
            "amount": "1000000"
          }
        ],
        "last_updated": 9,
        "last_weight": "1000000"
      }
    }
  ]
}
```

| Key              | Type               | Description                                            |
|------------------|--------------------|--------------------------------------------------------|
| `reward_buckets` | Vec\<RewardBucket> | The reward buckets that can be claimed by the address. |

{% endtab %}
{% endtabs %}

### Rewards

Returns the rewards for the given address.

{% tabs %}
{% tab title="Query" %}

```json
{
  "rewards": {
    "address": "migaloo1..."
  }
}
```

{% endtab %}

{% tab title="Response (RewardsResponse)" %}

```json
{
  "rewards": [
    {
      "denom": "uwhale",
      "amount": "500000"
    }
  ]
}
```

| Key       | Type       | Description                                     |
|-----------|------------|-------------------------------------------------|
| `rewards` | Vec\<Coin> | The rewards that can be claimed by the address. |

{% endtab %}
{% endtabs %}